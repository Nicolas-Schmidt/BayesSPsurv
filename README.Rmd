---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# BayesSPsurv

<!-- badges: start -->
[![R build status](https://github.com/Nicolas-Schmidt/spatialSPsurv/workflows/R-CMD-check/badge.svg)](https://github.com/Nicolas-Schmidt/BayesSPsurv/actions)
[![Project Status: Active â€“ The project has reached a stable, usable
state and is being actively
developed.](https://www.repostatus.org/badges/latest/active.svg)](https://www.repostatus.org/#active)
[![License:
MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
`r badger::badge_devel("Nicolas-Schmidt/BayesMFSurv", "blue")`
<!-- badges: end -->

Bayesian parametric spatial split-populiation survival models for clustered event processes. The models account for both structural and spatial heterogeneity among "at risk" and "immune" populations, and incorporates time-varying covariates. This package currently implements Weibull, Exponential and Loglogistic forms for the duration component.  It allows for the creation of spatial weights matrix objects from point patterns by distance and presents a series of diagnostic tests and plots for easy visual diagnostics of convergence and spatial effects.




Manual [__here__](https://github.com/Nicolas-Schmidt/spatialSPsurv/blob/master/man/figures/manual_BayesSPsurv.pdf).



## Installation

``` r
source("https://install-github.me/Nicolas-Schmidt/BayesSPsurv")
```



```{r, echo = FALSE, warning=FALSE, message=FALSE}
#source('data-raw/fsps.r')
library(spduration)
```


### Functions


| Function |Description |
| ----------------- | -------------------------------------------------------------- | 
|`exchangeSPsurv`|Markov Chain Monte Carlo (MCMC) to run Bayesian split population survival model with exchangeable frailties.|
|`pooledSPsurv` | Markov Chain Monte Carlo (MCMC) to run Bayesian split population survival model with no frailties|
|`spatialSPsurv`|Markov Chain Monte Carlo (MCMC) to run time-varying Bayesian split population survival model with spatial frailties.|
|`summary`|returns a summary of exchangeSPsurv, pooledSPsurv or spatialSPsurv object via `coda::summary.mcmc`.|
|`spatial_SA`|| creates spatial weights matrix using distance between capital cities as the threshold. 
|`SPstats`|A function to calculate the deviance information criterion (DIC) and Log-likelihood for fitted model oupts.|




### Example


```{r, fig.width = 13, fig.height = 10, warning = FALSE}

library(BayesSPsurv)

## Data
walter <- spduration::add_duration(Walter_2015_JCR,"renewed_war", 
                                   unitID = "id", tID = "year", 
                                   freq = "year", ongoing = FALSE)
walter <- BayesSPsurv::spatial_SA(data = walter, var_ccode = "ccode", threshold = 800L)


set.seed(123456)

model <- 
    spatialSPsurv(
        duration = duration ~ fhcompor1 + lgdpl + comprehensive + victory + 
                              instabl + intensityln + ethfrac + unpko,
        immune   = cured ~ fhcompor1 + lgdpl + victory,
        Y0       = 't.0',
        LY       = 'lastyear',
        S        = 'sp_id' ,
        data     = walter[[1]],
        N        = 500,
        burn     = 10,
        thin     = 10,
        w        = c(1,1,1),
        m        = 10,
        form     = "Weibull",
        prop.var = 1e-05,
        A        = walter[[2]]
    )

print(model)

SPstats(model)

```

## Map

```{r}
spw   <- matrix(apply(model$W, 2, mean), ncol = 1, nrow = ncol(model$W))
ccode <- colnames(model$W)
ISO3  <- countrycode::countrycode(ccode,'gwn','iso3c')
spw   <- data.frame(ccode = ccode, ISO3 = ISO3, spw = spw) 
map   <- rworldmap::joinCountryData2Map(spw, joinCode = "ISO3", nameJoinColumn = "ISO3")
rworldmap::mapCountryData(map, nameColumnToPlot = 'spw')

```

```{r, echo = FALSE}
# == == == == == == == == == == == == == == == == == == == == == =
set.seed(782566)
exchangeSPsurv <- 
    exchangeSPsurv(
        duration = duration ~ fhcompor1 + lgdpl + comprehensive + victory + 
                              instabl + intensityln + ethfrac + unpko,
        immune   = cured ~ fhcompor1 + lgdpl + victory,
        Y0       = 't.0',
        LY       = 'lastyear',
        S        = 'sp_id' ,
        data     = walter[[1]],
        N        = 100,
        burn     = 10,
        thin     = 10,
        w        = c(1,1,1),
        m        = 10,
        form     = "Weibull",
        prop.var = 1e-05
    )

set.seed(782566)

pooledSPsurv <- 
    pooledSPsurv(
        duration = duration ~ fhcompor1 + lgdpl + comprehensive + victory + 
                              instabl + intensityln + ethfrac + unpko,
        immune   = cured ~ fhcompor1 + lgdpl + victory,
        Y0       = 't.0',
        LY       = 'lastyear',
        data     = walter[[1]],
        N        = 100,
        burn     = 10,
        thin     = 10,
        w        = c(1,1,1),
        m        = 10,
        form     = "Weibull"
    )

# == == == == == == == == == == == == == == == == == == == == == =
```



```{r, }
# == == == == == == == == == == == == == == == == == == == == == =
str(model) # spatialSPsurv
#
#
#
str(exchangeSPsurv)
#
#
#
str(pooledSPsurv)
# == == == == == == == == == == == == == == == == == == == == == =
```



```{r echo=FALSE, message=FALSE}
manual <- function(){
    old <- here::here()
    path <- here::here('man', 'figures')
    sink('noise.txt')
    devtools::build_manual(path = path)
    sink()
    setwd(path)
    invisible(file.rename(list.files(pattern="^BayesSPsurv"), 'manual_BayesSPsurv.pdf'))
    setwd(old)
    invisible(file.remove('noise.txt'))
}
manual()
```























